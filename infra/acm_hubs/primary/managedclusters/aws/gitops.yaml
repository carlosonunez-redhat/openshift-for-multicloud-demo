---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: managed-cluster-aws-gitops-placement
  namespace: flux-system
spec:
  interval: 1m0s
  sourceRef:
    kind: GitRepository
    name: cluster-config
    namespace: flux-system
  path: ./infra/components/resources/acm/placement
  wait: true
  prune: true
  force: true
  patches:
    - target:
        kind: Placement
        name: replace-me
        namespace: openshift-gitops
      patch: |-
        - op: replace
          path: /metadata/name
          value: aws-gitops-placement
        - op: replace
          path: /spec/clusterSets
          value: ["global"]
        - op: replace
          path: /spec/predicates/0/requiredClusterSelector/labelSelector/matchExpressions
          value:
            - key: cloud
              operator: In
              values:
                - Amazon
            - key: name
              operator: NotIn
              values:
                - local-cluster
        - op: replace
          path: /spec/tolerations
          value:
            - key: cluster.open-cluster-management.io/unreachable
              operator: Equal
            - key: cluster.open-cluster-management.io/unavailable
              operator: Equal
        - op: replace
          path: /spec/template/spec/destination/namespace
          value: managed-cluster-aws

---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: gitops-cluster-aws
  namespace: flux-system
spec:
  interval: 1m0s
  sourceRef:
    kind: GitRepository
    name: cluster-config
    namespace: flux-system
  path: ./infra/components/resources/argocd/cluster
  wait: true
  prune: true
  patches:
    - target:
        kind: GitOpsCluster
        name: replace-me
        namespace: openshift-gitops
      patch: |-
        - op: replace
          path: /metadata/name
          value: gitops-cluster-aws
        - op: replace
          path: /spec/placementRef/name
          value: aws-gitops-placement
    - target:
        kind: Namespace
        name: replace-me
      patch: |-
        - op: replace
          path: /metadata/name
          value: gitops-clusters
---

apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: managed-cluster-aws-infra
  namespace: flux-system
spec:
  interval: 1m0s
  sourceRef:
    kind: GitRepository
    name: cluster-config
    namespace: flux-system
  path: ./infra/components/resources/argocd/appset
  wait: true
  prune: true
  force: true
  patches:
    - target:
        kind: ApplicationSet
        name: replace-me
      patch: |-
        - op: replace
          path: /metadata/name
          value: managed-cluster-aws-infra
        - op: replace
          path: /spec/template/metadata/annotations/apps.open-cluster-management.io~1ocm-managed-cluster
          value: managed-cluster-aws
        - op: replace
          path: /spec/template/metadata/name
          value: managed-cluster-aws-infra
        - op: replace
          path: /spec/template/spec/sources
          value:
            - repoURL: ssh://git@github.com:22/carlosonunez-redhat/openshift-for-multicloud-demo
              targetRevision: main
              path: ./infra/clusters/aws/infra
              directory:
                recurse: true
        - op: replace
          path: /spec/generators/0/clusterDecisionResource/labelSelector/matchLabels/cluster.open-cluster-management.io~1placement
          value: aws-gitops-placement

---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: managed-cluster-aws-apps
  namespace: flux-system
spec:
  interval: 1m0s
  sourceRef:
    kind: GitRepository
    name: cluster-config
    namespace: flux-system
  path: ./infra/components/resources/argocd/appset
  wait: true
  prune: true
  force: true
  patches:
    - target:
        kind: ApplicationSet
        name: replace-me
      patch: |-
        - op: replace
          path: /metadata/name
          value: managed-cluster-aws-apps
        - op: replace
          path: /spec/template/metadata/annotations/apps.open-cluster-management.io~1ocm-managed-cluster
          value: managed-cluster-aws
        - op: replace
          path: /spec/template/metadata/name
          value: managed-cluster-aws-apps
        - op: replace
          path: /spec/generators/0/clusterDecisionResource/labelSelector/matchLabels/cluster.open-cluster-management.io~1placement
          value: aws-gitops-placement
        - op: replace
          path: /spec/template/spec/sources
          value:
            - repoURL: ssh://git@github.com:22/carlosonunez-redhat/openshift-for-multicloud-demo
              targetRevision: main
              path: ./infra/clusters/aws/apps
              directory:
                recurse: true
        - op: replace
          path: /spec/template/spec/destination/namespace
          value: managed-cluster-aws
